<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Файловая структура</title>
  <style>
    :root {
      --primary-color: #1a73e8;
      --secondary-color: #34a853;
      --accent-color: #fbbc05;
      --danger-color: #ea4335;
      --background-color: #f0f2f5;
      --card-background: white;
      --text-primary: #202124;
      --text-secondary: #5f6368;
      --hover-color: #e8f0fe;
    }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-primary);
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color), #4285f4);
      color: white;
      padding: 30px 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,5 C60,20 40,20 0,5 Z" fill="%23ffffff" opacity="0.1"/></svg>');
      background-size: 100% 100%;
    }

    .header h1 {
      font-size: 2.8em;
      margin-bottom: 10px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .header p {
      font-size: 1.2em;
      margin: 0;
      opacity: 0.9;
    }

    .controls {
      background: var(--card-background);
      padding: 15px 20px;
      border-radius: 8px;
      margin: -20px auto 20px;
      max-width: 1200px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 10;
      position: relative;
    }

    .controls-bottom {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 15px;
    }

    .search-box {
      width: 100%;
      position: relative;
    }

    .search-box input {
      width: 90%;
      padding: 12px 15px 12px 40px;
      border: 1px solid #ddd;
      border-radius: 30px;
      font-size: 16px;
      transition: all 0.3s;
      outline: none;
    }

    .search-box input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
    }

    .search-box::before {
      content: '\f002';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }

    .filter-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .filter-btn {
      background: var(--card-background);
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .filter-btn:hover {
      background: var(--hover-color);
      border-color: var(--primary-color);
    }

    .filter-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .product-counter {
      background: var(--card-background);
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 8px 15px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
    }

    .product-counter i {
      color: var(--primary-color);
    }

    .product-counter span {
      font-weight: 600;
      color: var(--primary-color);
    }

    .container {
      max-width: 1400px;
      margin: 20px auto;
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      padding: 0 20px 40px;
      justify-content: center;
    }

    .card {
      background: var(--card-background);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      width: 280px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color), var(--danger-color));
    }

    .card-header {
      margin-bottom: 20px;
    }

    .card h3 {
      margin: 0 0 15px;
      color: var(--primary-color);
      font-size: 1.3em;
      font-weight: 600;
      line-height: 1.3;
    }

    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .meta-tag {
      background: #f0f7ff;
      color: var(--primary-color);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .file-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .file-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex-grow: 1;
    }

    .file-list li {
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    .file-list li:hover {
      background: var(--hover-color);
      transform: translateX(5px);
    }

    .file-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .file-icon i {
      font-size: 16px;
    }

    .file-name {
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Цветовое кодирование для разных типов файлов */
    .file-type-Изображение {
      background-color: rgba(52, 168, 83, 0.1);
      border-left: 3px solid var(--secondary-color);
    }

    .file-type-Изображение .file-icon {
      background-color: rgba(52, 168, 83, 0.2);
      color: var(--secondary-color);
    }

    .file-type-Документ {
      background-color: rgba(26, 115, 232, 0.1);
      border-left: 3px solid var(--primary-color);
    }

    .file-type-Документ .file-icon {
      background-color: rgba(26, 115, 232, 0.2);
      color: var(--primary-color);
    }

    .file-type-3D-модель {
      background-color: rgba(251, 188, 5, 0.1);
      border-left: 3px solid var(--accent-color);
    }

    .file-type-3D-модель .file-icon {
      background-color: rgba(251, 188, 5, 0.2);
      color: var(--accent-color);
    }

    .file-type-Другое {
      background-color: rgba(234, 67, 53, 0.1);
      border-left: 3px solid var(--danger-color);
    }

    .file-type-Другое .file-icon {
      background-color: rgba(234, 67, 53, 0.2);
      color: var(--danger-color);
    }

    .empty-files {
      padding: 20px;
      text-align: center;
      color: var(--text-secondary);
      font-style: italic;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .card-footer {
      margin-top: 15px;
      text-align: center;
    }

    .view-all {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      color: var(--primary-color);
      font-size: 14px;
      text-decoration: none;
      padding: 8px 15px;
      border-radius: 20px;
      transition: all 0.2s;
      border: 1px solid var(--primary-color);
    }

    .view-all:hover {
      background: var(--hover-color);
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    /* Анимации */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      animation: fadeIn 0.5s ease forwards;
    }

    /* Стили для миниатюры изображения */
    .product-thumbnail {
      width: 100%;
      height: 160px;
      border-radius: 8px 8px 0 0;
      object-fit: cover;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .thumbnail-container {
      margin: -20px -20px 15px -20px;
      position: relative;
      overflow: hidden;
      border-radius: 12px 12px 0 0;
      background-color: #f5f5f5;
    }

    .no-image {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 160px;
      background-color: #f5f5f5;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* Адаптивный дизайн */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .card {
        width: 100%;
      }

      .controls {
        margin: -20px 20px 20px;
      }

      .filter-group {
        overflow-x: auto;
        padding-bottom: 5px;
        justify-content: flex-start;
        width: 100%;
      }

      .product-counter {
        justify-content: center;
      }

      .header h1 {
        font-size: 2.2em;
      }
    }

    /* Темная тема */
    @media (prefers-color-scheme: dark) {
      :root {
        --background-color: #121212;
        --card-background: #1e1e1e;
        --text-primary: #e0e0e0;
        --text-secondary: #a0a0a0;
        --hover-color: #2c2c2c;
      }

      .file-list li {
        background: #2a2a2a;
      }

      .search-box input {
        background: #2a2a2a;
        border-color: #444;
        color: var(--text-primary);
      }

      .filter-btn {
        background: #2a2a2a;
        border-color: #444;
        color: var(--text-primary);
      }

      .empty-files {
        background: #2a2a2a;
      }
    }

  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="header">
    <h1>Файловая структура</h1>
    <p>Интерактивный обзор категорий и файлов</p>
  </div>

  <div class="controls">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Поиск по названию, категории или типу файла...">
    </div>
    <div class="controls-bottom">
      <div class="filter-group">
        <button class="filter-btn active" data-filter="all"><i class="fas fa-layer-group"></i> Все</button>
        <button class="filter-btn" data-filter="Изображение"><i class="fas fa-file-image"></i> Изображения</button>
        <button class="filter-btn" data-filter="Документ"><i class="fas fa-file-word"></i> Документы</button>
        <button class="filter-btn" data-filter="3D модель"><i class="fas fa-cube"></i> 3D модели</button>
        <button class="filter-btn" data-filter="no3d"><i class="fas fa-ban"></i> Без 3D моделей</button>
        <button class="filter-btn" data-filter="noDocument"><i class="fas fa-ban"></i> Без документов</button>
      </div>
      <div class="product-counter">
        <i class="fas fa-box"></i> Отображено: <span id="productCount">0</span> из <span id="totalCount">0</span>
        товаров
      </div>
    </div>
  </div>

  <div class="container" id="fileContainer"></div>

  <script>
    // Улучшенная функция определения иконок
    function getFileIcon(type) {
      const iconMap = {
        'Изображение': 'fas fa-file-image',
        'Документ': 'fas fa-file-word',
        '3D модель': 'fas fa-cube',
        'Архив': 'fas fa-file-archive',
        'Другое': 'fas fa-file'
      };

      return iconMap[type] || 'fas fa-file';
    }

    // Функция для подсчета типов файлов
    function countFileTypes(files) {
      const counts = {
        'Изображение': 0,
        'Документ': 0,
        '3D модель': 0,
        'Другое': 0
      };

      // Проверяем, что files существует и является массивом
      if (files && Array.isArray(files)) {
        files.forEach(file => {
          if (counts[file.type] !== undefined) {
            counts[file.type]++;
          } else {
            counts['Другое']++;
          }
        });
      }

      return counts;
    }

    // Функция для сокращения длинных имен файлов
    function truncateFilename(filename, maxLength = 25) {
      if (filename.length <= maxLength) return filename;

      const extension = filename.split('.').pop();
      const nameWithoutExt = filename.substring(0, filename.lastIndexOf('.'));

      if (nameWithoutExt.length <= maxLength - 3 - extension.length) {
        return nameWithoutExt + '.' + extension;
      }

      return nameWithoutExt.substring(0, maxLength - 3 - extension.length) + '...' + '.' + extension;
    }

    let allData = [];
    let filteredData = [];

    async function loadData() {
      try {
        const response = await fetch('data.json');
        allData = await response.json();
        filteredData = [...allData];
        // Обновляем общее количество товаров
        document.getElementById('totalCount').textContent = allData.length;
        // Проверяем наличие директории images, если её нет, создаем сообщение об ошибке
        checkImagesDirectory();
        console.log('Данные загружены успешно:', allData.length, 'записей');
        renderCards(filteredData);
      } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        document.getElementById('fileContainer').innerHTML = `
          <div style="text-align: center; padding: 50px; color: var(--danger-color);">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
            <h2>Ошибка загрузки данных</h2>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    function renderCards(data) {
      const container = document.getElementById('fileContainer');
      container.innerHTML = '';

      // Обновляем счетчик отображаемых товаров
      document.getElementById('productCount').textContent = data.length;

      if (data.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px;"></i>
            <h2>Ничего не найдено</h2>
            <p>Попробуйте изменить параметры поиска или фильтрации</p>
          </div>
        `;
        return;
      }

      data.forEach(category => {
        const card = document.createElement('div');
        card.classList.add('card');
        card.setAttribute('data-category', category.category);
        card.setAttribute('data-subcategory', category.subcategory);

        // Подсчет типов файлов
        const fileCounts = countFileTypes(category.files);

        // Находим первое изображение для миниатюры
        let firstImage = null;
        if (category.files && Array.isArray(category.files)) {
          firstImage = category.files.find(file => file.type === 'Изображение');
        }

        // Добавляем миниатюру, если есть изображение
        if (firstImage) {
          const thumbnailContainer = document.createElement('div');
          thumbnailContainer.classList.add('thumbnail-container');

          // Создаем элемент изображения с реальным путем к файлу
          // Проверяем путь к изображению и формируем корректный URL
          const imageUrl = `http://192.168.0.86:3000/files/${firstImage.filepath.replace(/\\/g, '/')}`;
          thumbnailContainer.innerHTML = `
            <img src="${imageUrl}" 
                 alt="${category.product}" 
                 class="product-thumbnail" 
                 title="${firstImage.filename}" 
                 onerror="this.onerror=null; this.src='https://via.placeholder.com/300x160?text=${encodeURIComponent(category.product)}'">
          `;
          card.appendChild(thumbnailContainer);
        } else {
          // Если изображений нет, показываем заглушку
          const noImageContainer = document.createElement('div');
          noImageContainer.classList.add('thumbnail-container');
          noImageContainer.innerHTML = `
            <div class="no-image">
              <i class="fas fa-image"></i> Нет изображений
            </div>
          `;
          card.appendChild(noImageContainer);
        }

        // Создаем верхнюю часть карточки
        const cardHeader = document.createElement('div');
        cardHeader.classList.add('card-header');
        cardHeader.innerHTML = `<h3>${category.product}</h3>`;

        // Добавляем метки категорий
        const cardMeta = document.createElement('div');
        cardMeta.classList.add('card-meta');
        cardMeta.innerHTML = `
          <span class="meta-tag"><i class="fas fa-folder"></i> ${category.category}</span>
          <span class="meta-tag"><i class="fas fa-tag"></i> ${category.subcategory}</span>
        `;

        // Добавляем статистику файлов
        const fileStats = document.createElement('div');
        fileStats.classList.add('file-stats');
        fileStats.innerHTML = `
          <div class="stat-item">
            <div class="stat-value">${category.files && Array.isArray(category.files) ? category.files.length : 0}</div>
            <div class="stat-label">Всего</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${fileCounts['Изображение']}</div>
            <div class="stat-label">Изображения</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${fileCounts['Документ']}</div>
            <div class="stat-label">Документы</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">${fileCounts['3D модель']}</div>
            <div class="stat-label">3D модели</div>
          </div>
        `;

        card.appendChild(cardHeader);
        card.appendChild(cardMeta);
        card.appendChild(fileStats);

        // Добавляем кнопку "Показать файлы"
        if (category.files && Array.isArray(category.files) && category.files.length > 0) {
          const cardFooter = document.createElement('div');
          cardFooter.classList.add('card-footer');
          cardFooter.innerHTML = `
            <a href="#" class="view-all" data-product="${category.product}">
              <i class="fas fa-eye"></i> Показать файлы (${category.files.length}) <i class="fas fa-chevron-right"></i>
            </a>
          `;
          card.appendChild(cardFooter);
        }
        else {
          const emptyFiles = document.createElement('div');
          emptyFiles.classList.add('empty-files');
          emptyFiles.innerHTML = '<i class="fas fa-folder-open"></i> Нет файлов';
          card.appendChild(emptyFiles);
        }

        container.appendChild(card);
      });

      // Добавляем обработчики событий для кнопок "Показать все"
      document.querySelectorAll('.view-all').forEach(button => {
        button.addEventListener('click', function (e) {
          e.preventDefault();
          const productName = this.getAttribute('data-product');
          const category = allData.find(cat => cat.product === productName);

          if (category) {
            showAllFiles(category);
          }
        });
      });
    }

    // Функция для проверки наличия директории с изображениями
    function checkImagesDirectory() {
      // Добавляем сообщение в консоль для отладки
      console.log('Проверка доступности изображений...');
      // Здесь можно добавить дополнительную логику проверки, если необходимо
    }

    // Функция для отображения всех файлов в модальном окне
    function showAllFiles(category) {
      // Создаем модальное окно
      const modal = document.createElement('div');
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100%';
      modal.style.height = '100%';
      modal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
      modal.style.zIndex = '1000';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.padding = '20px';

      // Создаем содержимое модального окна
      const modalContent = document.createElement('div');
      modalContent.style.backgroundColor = 'var(--card-background)';
      modalContent.style.borderRadius = '12px';
      modalContent.style.padding = '25px';
      modalContent.style.maxWidth = '800px';
      modalContent.style.width = '100%';
      modalContent.style.maxHeight = '80vh';
      modalContent.style.overflow = 'auto';
      modalContent.style.position = 'relative';
      modalContent.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.3)';

      // Добавляем заголовок и кнопку закрытия
      modalContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; color: var(--primary-color);">${category.product}</h2>
          <button id="closeModal" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div style="margin-bottom: 20px;">
          <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <span class="meta-tag"><i class="fas fa-folder"></i> ${category.category}</span>
            <span class="meta-tag"><i class="fas fa-tag"></i> ${category.subcategory}</span>
          </div>
        </div>
      `;

      // Создаем список всех файлов
      const fileList = document.createElement('ul');
      fileList.classList.add('file-list');
      fileList.style.maxHeight = '60vh';
      fileList.style.overflowY = 'auto';
      fileList.style.padding = '10px';
      fileList.style.margin = '0';

      // Проверяем, что category.files существует и является массивом
      if (category.files && Array.isArray(category.files)) {
        category.files.forEach(file => {
          const fileItem = document.createElement('li');
          fileItem.classList.add(`file-type-${file.type.replace(/ /g, '-')}`);

          const fileIcon = document.createElement('div');
          fileIcon.classList.add('file-icon');
          fileIcon.innerHTML = `<i class="${getFileIcon(file.type)}"></i>`;

          const fileName = document.createElement('div');
          fileName.classList.add('file-name');
          fileName.setAttribute('title', file.filename);
          fileName.textContent = file.filename;

          fileItem.appendChild(fileIcon);
          fileItem.appendChild(fileName);
          fileList.appendChild(fileItem);
        });
      } else {
        // Если файлов нет или массив не определен
        const emptyMessage = document.createElement('div');
        emptyMessage.classList.add('empty-files');
        emptyMessage.innerHTML = '<i class="fas fa-folder-open"></i> Нет файлов';
        fileList.appendChild(emptyMessage);
      }

      modalContent.appendChild(fileList);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      // Добавляем обработчик для закрытия модального окна
      document.getElementById('closeModal').addEventListener('click', function () {
        document.body.removeChild(modal);
      });

      // Закрытие по клику вне модального окна
      modal.addEventListener('click', function (e) {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });
    }

    // Функция для фильтрации данных
    function filterData() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');

      filteredData = allData.filter(category => {
        // Фильтрация по поисковому запросу
        const matchesSearch =
          searchTerm === '' ||
          category.product.toLowerCase().includes(searchTerm) ||
          category.category.toLowerCase().includes(searchTerm) ||
          category.subcategory.toLowerCase().includes(searchTerm) ||
          category.files.some(file => file.filename.toLowerCase().includes(searchTerm));

        // Фильтрация по типу файла
        let matchesFileType = false;

        if (activeFilter === 'all') {
          matchesFileType = true;
        } else if (activeFilter === 'no3d') {
          const fileCounts = countFileTypes(category.files);
          matchesFileType = fileCounts['3D модель'] === 0;
        } else if (activeFilter === 'noDocument') {
          // Проверяем, что в категории нет документов
          const fileCounts = countFileTypes(category.files);
          matchesFileType = fileCounts['Документ'] === 0; // Если нет документов
        } else {
          matchesFileType = category.files.some(file => file.type === activeFilter);
        }

        return matchesSearch && matchesFileType;
      });

      renderCards(filteredData);
    }

    // Инициализация приложения
    document.addEventListener('DOMContentLoaded', function () {
      loadData();

      // Обработчик для поиска
      document.getElementById('searchInput').addEventListener('input', filterData);

      // Обработчики для кнопок фильтрации
      document.querySelectorAll('.filter-btn').forEach(button => {
        button.addEventListener('click', function () {
          document.querySelector('.filter-btn.active').classList.remove('active');
          this.classList.add('active');
          filterData();
        });
      });
    });
  </script>
</body>

</html>
